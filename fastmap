#!/bin/bash
#fastmap

# Function to display usage instructions
usage() {
    local exit_code="${1:-0}"
    echo "Usage: $0 [-u] [-6] <IP-TARGET>"
    echo
    echo "Options:"
    echo "  -h           Display this help message."
    echo "  -u           Include a UDP top-ports scan (requires sudo)."
    echo "  -6           Enable IPv6 scanning."
    echo
    echo "Description:"
    echo "This script performs a port scan on the target IP using Nmap. It first identifies open ports"
    echo "and then conducts a more detailed scan on those ports. Optionally, it performs a UDP top-ports scan."
    echo "The results are saved in a txt file named after the target IP address."
    exit "$exit_code"
}

# Parse command-line options
udp_scan=false
ipv6_scan=false
while getopts ":hu6" opt; do
    case "$opt" in
        h)
            usage
            ;;
        u)
            udp_scan=true
            ;;
        6)
            ipv6_scan=true
            ;;
        \?)
            echo "Error: Invalid option -$OPTARG" >&2
            usage 1
            ;;
    esac
done

shift $((OPTIND - 1))

# Verify that an IP address was provided
if [ $# -lt 1 ]; then
    echo "Error: No IP target provided."
    echo "Use -h for usage instructions."
    exit 1
fi

# Assign the first non-option argument to the variable IP_TARGET
IP_TARGET=$1

# Set nmap arguments based on flags
nmap_extra_args=""
if [ "$ipv6_scan" = "true" ]; then
    nmap_extra_args="-6"
fi

if [ "$udp_scan" = "true" ]; then
    echo "[*] UDP scan requested. Validating sudo credentials before scanning..."
    if ! sudo -v >/dev/null 2>&1; then
        echo "[!] Unable to obtain sudo privileges. Aborting UDP scan."
        exit 1
    fi
fi

# Record start time for runtime tracking
start_time=$(date +%s)

# Perform the initial Nmap scan to find open ports
echo "[*] Scanning for open TCP ports on $IP_TARGET..."
ports=$(nmap -Pn -p- --min-rate=1000 -T4 $nmap_extra_args "$IP_TARGET" | \
grep '^[0-9]' | \
cut -d '/' -f 1 | \
tr '\n' ',' | \
sed 's/,$//')

output_file="${IP_TARGET}.txt"

if [ -z "$ports" ]; then
    echo "[!] No open TCP ports found on $IP_TARGET."
    if [ "$udp_scan" != "true" ]; then
        exit 1
    fi
    {
        echo "## TCP scan"
        echo "No open TCP ports found."
    } > "$output_file"
else
    echo "[*] Performing a detailed TCP scan on the open ports ($ports)..."
    nmap_output=$(nmap -p"$ports" -Pn -sC -sV $nmap_extra_args "$IP_TARGET")

    {
        echo "## TCP scan"
        echo "$nmap_output"
    } > "$output_file"
fi

if [ "$udp_scan" = "true" ]; then
    echo "[*] Performing a UDP top-ports 1000 scan on $IP_TARGET..."
    udp_output=$(sudo nmap -sU -Pn -sV --top-ports 1000 -T4 --reason $nmap_extra_args "$IP_TARGET")

    {
        echo
        echo "## UDP scan (--top-ports 1000)"
        echo "$udp_output"
    } >> "$output_file"
fi

# Calculate and log runtime
end_time=$(date +%s)
elapsed_seconds=$((end_time - start_time))
elapsed_formatted=$(printf '%02d:%02d:%02d' $((elapsed_seconds / 3600)) $(((elapsed_seconds % 3600) / 60)) $((elapsed_seconds % 60)))

if [ -f "$output_file" ]; then
    {
        echo
        echo "## Runtime"
        echo "$elapsed_formatted"
    } >> "$output_file"
fi

# Notify the user of the saved results
echo "[+] Scan completed. Results saved to $output_file"
echo "[+] Total runtime: $elapsed_formatted"